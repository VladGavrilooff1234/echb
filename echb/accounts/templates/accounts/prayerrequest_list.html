{% extends "base.html" %}
{% load static %}
{% block breadcrumbs %}
{{ block.super }}
{% if active_page.slug != page.slug %}
<li><a href="{{active_page.slug}}" title="{{active_page.title}}">{{active_page.title}}</a></li>
{% endif %}
<li><a href="{% url 'profile' user.id %}">Личный кабинет</a></li>
{% endblock %}

{% block content %}
<article class="prayer-requests">
    <h2>
        Рабочий кабинет администратора
    </h2>
    {% if user.is_authenticated and not user.is_staff %}
    <h3>Ваши молитвенные нужды: </h3>
    <ul>
        {% for need in prayer_requests %}
        <li>{{need.description}}</li>
        {% empty %}
        <li>Их нет. Напишите о чем мы можем помолиться о вас <a href="{% url 'videos' %}">здесь.</a></li>
        {% endfor %}
    </ul>
    {% elif not user.is_staff %}
    <a href="{% url 'login' %}">login</a> /
    <a href="{% url 'signup' %}">signup</a>
    {% endif %}

    {% if user.is_staff %}
    <h3>Текущее видео от {{video.date|date:'d F Y H:i'}}</h3>
    <iframe width="100%" height="500px" src="{{video.youtube_link}}"
        frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>

    <h3>Молитвенные нужды посетителей сайта: </h3>
    <p>Здесь отображаются молитвенные нужды, оставленные после
        {{video.date|date:'d F Y H:i'}}</p>
    <p>Последнее обновление данных: <span id="last-update-time"></span></p>
    <div id="prayer-requests">
        {% for need in prayer_requests_all %}
        <div>
            <h4>Молитвенная нужда:</h4>
            <p>{{need.description}}</p>
            <p>{{need.user.first_name}} | {{need.created|date:'d F Y H:i'}}</p>
        </div>
        {% empty %}
        <li>Пусто</li>
        {% endfor %}
    </div>
    {% endif %}
    </header>
</article>

{% endblock content %}


{% block jsfooter %}
{% if user.is_staff %}
<script src="{% static 'js/third-party/tmpl.min.js' %}"></script>
<script src="{% static 'js/third-party/moment-with-locales.min.js' %}"></script>
<script>
    var echbNS = echbNS || {};
    echbNS.updateRequests = function () {
        $.getJSON('{% url "prayer_requests" %}', function (prayers) {
            $('#prayer-requests').empty();
            prayers.forEach(prayer => {
                moment.locale('ru');
                prayer.created = moment(prayer.created).format("D MMMM YYYY, HH:mm");
                content = tmpl("prayer-request", prayer);
                $('#prayer-requests').append(content);
            });
            $('#last-update-time').text(moment().format('D MMMM YYYY HH:mm'));
        });

    }
    $(document).ready(function () {
        setInterval(echbNS.updateRequests, 10 * 1000);
    });
</script>

{% verbatim %}
<script type="text/x-tmpl" id="prayer-request">
                <div>
                <h4>Молитвенная нужда:</h4>
                <p>{%= o.description %}</p>
                <p>{%= o.user__first_name %} | {%= o.created %}</p> 
            </div>

        </script>
{% endverbatim %}


{% endif %}
{% endblock jsfooter %}

{% block rightside %}
    {% include 'accounts/profile_menu.html' %}
{% endblock rightside %}