class App{constructor(s,e,t,i){this.regions=s,this.churches=e,this.gMap=t,this.closestChurchesQnty=i,this.showRegions(),this.showChurches(),this.initializeClosestChurches(),this.userPosition={},this.closestChurches=[]}showRegions(){document.getElementById("regions").innerHTML=tmpl("regions-list",this.regions),$("#regions").on("click","li a",function(s){return $(".regions-list__link").removeClass("regions-list__link--active"),$(this).addClass("regions-list__link--active"),!1}),$("#regions").on("click","li a",()=>{const s=document.getElementsByClassName("regions-list__link--active")[0].dataset.region;return this.gMap.resetDirections(),this.gMap.filterGpointsByRegion(s),!1})}initializeClosestChurches(){$("#get_closest_churches").on("click",()=>(this.showclosestChurches(),!1)),$("#closest-churches-list").on("click","li a",function(s){return $(this).parent().children(".closest-churches-list__list").toggleClass("closest-churches-list__list--none"),!1}),$("#closest-churches-list").on("click","li .closest-churches-list__button",s=>{let e={lat:s.target.dataset.lat,lng:s.target.dataset.lng};return this.gMap.calculateRoute(e,this.userPosition),!1})}filterGpointsByChurchIds(){this.addDistanceFromUserPosition(this.userPosition),this.closestChurches=this.getClosestChurches();let s=this.closestChurches.reduce((s,e)=>(s.push(e.pk),s),[]);this.gMap.filterGpointsByChurchIds(s)}showListOfChurches(){document.getElementById("closest-churches-list").innerHTML=tmpl("church-info-search",this.closestChurches)}setUserPosition(s){this.userPosition=s.coords}showclosestChurches(){navigator.geolocation?navigator.geolocation.getCurrentPosition(s=>{this.setUserPosition(s),s&&(this.filterGpointsByChurchIds(),this.showListOfChurches(),this.gMap.addUserGpoint(this.userPosition))},function(){this.showMessage("Невозможно определить ваше положение.")}):this.showMessage("Ваш браузер не поддерживает функцию Геолокации.")}showMessage(s){$("#messages").innerHTML=s}getRadian(s){return s*Math.PI/180}addDistanceFromUserPosition(){this.churches.forEach(s=>{var e=this.getRadian(s.fields.lat-this.userPosition.latitude),t=this.getRadian(s.fields.lng-this.userPosition.longitude),i=Math.sin(e/2)*Math.sin(e/2)+Math.cos(this.getRadian(this.userPosition.latitude))*Math.cos(this.getRadian(this.userPosition.latitude))*Math.sin(t/2)*Math.sin(t/2),o=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));s.distanceFromUser=Math.round(6371*o)})}getClosestChurches(){return this.churches.sort((s,e)=>s.distanceFromUser-e.distanceFromUser),this.churches.slice(0,this.closestChurchesQnty)}showChurches(){const s=[];this.churches.forEach(e=>{let t=this.gMap.createGmapMarker(e);this.gMap.addChurchClickListener(e,t),s.push(t)}),this.gMap.addMarkersToMap(s)}}class Data{constructor(s,e){this.regionsUrl=s,this.churchesUrl=e,this.regionsData=[]}getPromise(){return new Promise((s,e)=>this.getRegions(s))}getRegions(s,e){fetch(this.regionsUrl).then(s=>s.json()).then(e=>this.getChurches(e,s))}getChurches(s,e){this.regionsData=s,fetch(this.churchesUrl).then(s=>s.json()).then(t=>{let i=this.addRegionNameToChurch(s,t);e(i)})}addRegionNameToChurch(s,e){let t={};return t.regions=s,t.churches=e.map(s=>(s.fields.region_name=this.getRegionNameById(s.fields.region),s)),t}getRegionNameById(s){return this.regionsData.filter(e=>e.pk==s)[0].fields.name}}class GMapServices{constructor(s,e,t,i,o){this.map=this.createMap(s,e,t,i),this.map.gmarkers=[],this.directionsService=new o.maps.DirectionsService,this.directionsDisplay=new o.maps.DirectionsRenderer,this.infoWindow=new o.maps.InfoWindow}createMap(s,e,t,i){return new google.maps.Map(document.getElementById(i),{center:{lat:s,lng:e},zoom:t})}addChurchClickListener(s,e){google.maps.event.addListener(e,"click",function(s,e,t){const i=tmpl("church-info-gmap",s.fields);return function(){t.setContent(i),t.open(this.map,e)}}(s,e,this.infoWindow))}createGmapMarker(s){return new google.maps.Marker({position:new google.maps.LatLng(s.fields.lat,s.fields.lng),map:this.map,regionId:s.fields.region,churchId:s.pk,icon:"/static/img/church-gmap.png"})}filterGpointsByChurchIds(s){var e=new google.maps.LatLngBounds;this.map.gmarkers.forEach(t=>{if(s.indexOf(t.churchId)>-1){let s=new google.maps.LatLng(t.position.lat(),t.position.lng());e.extend(s),t.setVisible(!0)}else t.setVisible(!1)}),this.map.fitBounds(e)}filterGpointsByRegion(s){var e=new google.maps.LatLngBounds;this.map.gmarkers.forEach(t=>{if(0==s||t.regionId==s){let s=new google.maps.LatLng(t.position.lat(),t.position.lng());e.extend(s),t.setVisible(!0)}else t.setVisible(!1)}),this.map.fitBounds(e)}addUserGpoint(s){const e=new google.maps.Marker({position:new google.maps.LatLng(s.latitude,s.longitude),map:this.map,regionId:0,churchId:0,icon:"/static/img/location.png"});this.map.gmarkers.push(e)}resetDirections(){this.directionsDisplay.setMap(null)}calculateRoute(s,e){const t=new google.maps.LatLng(e.latitude,e.longitude),i=new google.maps.LatLng(s.lat,s.lng);let o=new google.maps.LatLngBounds;o.extend(t),o.extend(i),this.map.fitBounds(o);const n={origin:t,destination:i,travelMode:google.maps.TravelMode.DRIVING};this.directionsService.route(n,(s,e)=>{e==google.maps.DirectionsStatus.OK?(this.directionsDisplay.setDirections(s),this.directionsDisplay.setMap(this.map)):console.log("Directions Request from "+t.toUrlValue(6)+" to "+i.toUrlValue(6)+" failed: "+e)})}addMarkersToMap(s){this.map.gmarkers=s}}